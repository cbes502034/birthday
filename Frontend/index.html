<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>生日抽卡遊戲｜方形卡片 + 星象裝飾</title>
  <style>
    :root{
      --bg-image: url('bg.jpg');
      --ink: #eaf6ff;
      --ink-weak:#b8d0f5;
      --paper: rgba(10, 20, 60, 0.45);
      --line: rgba(255,255,255,0.10);
      --accent:#ffd54a;
      --accent-2:#8ec5ff;
      --glass: rgba(10,20,60,0.78);
      --wrap-w: 1200px;
      --hud-h: 72px;

      /* 流星游標（fallback = default，不會出手指） */
      --cursor-meteor: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'>\
<defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>\
<stop offset='0' stop-color='%23ffd54a'/><stop offset='1' stop-color='%238ec5ff'/>\
</linearGradient></defs>\
<circle cx='8' cy='8' r='5.2' fill='url(%23g)'/>\
<circle cx='7.2' cy='7.2' r='2.2' fill='white' fill-opacity='.65'/>\
<path d='M8 8 L33 3' stroke='%238ec5ff' stroke-width='2.6' stroke-linecap='round' stroke-opacity='.72'/>\
<path d='M9.5 9.5 L31 15' stroke='%23ffd54a' stroke-width='2.2' stroke-linecap='round' stroke-opacity='.85'/>\
</svg>") 6 6, default;
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background-image: var(--bg-image);
      background-size: cover; background-position: center; background-attachment: fixed;
      overflow-x:hidden;
      cursor: var(--cursor-meteor) !important;
    }
    :where(.card, .btn, button, .history-toggle, [role="button"], a){ cursor: var(--cursor-meteor) !important; }
    :where(.card, .btn, button, .history-toggle, [role="button"], a) *{ cursor: inherit !important; }

    /* ===== 透明 HUD ===== */
    .hud{ position: sticky; top: 0; z-index: 1600; height: var(--hud-h); background: transparent!important; border:none!important; }
    .hud-inner{
      width:min(var(--wrap-w), 96vw); margin:0 auto; height:100%;
      display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:16px;
    }
    .hud-left{ display:flex; align-items:center; gap:12px; }
    .hud-right{ justify-self:end; display:flex; align-items:center; gap:12px; }
    .hud-title{
      margin:0; justify-self:center; font-size: clamp(22px, 2.8vw, 40px);
      letter-spacing:.08em; color:#ffe28a; font-weight:900;
      text-shadow: 0 0 12px rgba(255,226,138,.35), 0 0 28px rgba(255,226,138,.22);
      position:relative; padding:2px 10px; border-radius:10px; animation: neonPulse 3.6s ease-in-out infinite;
    }
    .hud-title::after{
      content:""; position:absolute; inset:-1px; border-radius:inherit;
      background: linear-gradient(90deg, transparent, rgba(255,226,138,.55), transparent);
      filter: blur(8px); transform: translateX(-120%); animation: shine 4.8s ease-in-out infinite; mix-blend-mode: screen;
    }
    @keyframes neonPulse{0%,100%{text-shadow:0 0 12px rgba(255,226,138,.35),0 0 28px rgba(255,226,138,.22);}50%{text-shadow:0 0 18px rgba(255,226,138,.6),0 0 46px rgba(255,226,138,.35);}}
    @keyframes shine{0%{transform:translateX(-120%)}50%{transform:translateX(120%)}100%{transform:translateX(220%)}}

    .pill{
      padding:8px 14px; border:1px solid var(--accent); border-radius:999px; color:var(--accent);
      background: radial-gradient(120% 180% at 0% 0%, rgba(255,213,74,.18), transparent 60%), rgba(255,213,74,.10);
      font-weight:800; box-shadow: 0 4px 12px rgba(0,0,0,.35); display:inline-flex; align-items:center; gap:10px; animation: breathe 2.8s ease-in-out infinite;
    }
    .pill .dot{ width:8px; height:8px; border-radius:50%; background: var(--accent); box-shadow:0 0 10px rgba(255,213,74,.8); }
    @keyframes breathe{0%,100%{transform:translateZ(0);}50%{transform:scale(1.03);}}

    .score-box{ min-width:112px; padding:8px 12px; border:1px solid var(--accent); border-radius:12px; background: var(--glass); box-shadow:0 6px 16px rgba(0,0,0,.45); }
    .score-title{ font-size:12px; color:var(--accent); margin-bottom:2px; }
    .score-value{ font-size:22px; font-weight:900; letter-spacing:.02em; }

    .history-toggle{ padding:8px 12px; border:1px solid var(--accent); border-radius:12px; background: linear-gradient(180deg, rgba(255,213,74,.16), rgba(255,213,74,.06)); color:var(--accent); font-weight:800; }
    .history-panel{
      position: fixed; right: 16px; top: calc(var(--hud-h) + 8px); z-index: 2001; width: min(300px, 84vw);
      background: rgba(10,20,60,.94); border:1px solid var(--accent); border-radius:14px; box-shadow:0 18px 44px rgba(0,0,0,.6);
      padding:12px; max-height:60vh; overflow:auto;
    }
    #historyList{ list-style:none; margin:0; padding:0; }
    #historyList li{ display:grid; grid-template-columns: 60px 1fr auto; gap:8px; align-items:center; padding:6px 4px; border-bottom:1px dashed rgba(255,255,255,.15); font-size:14px; }
    #historyList li:last-child{ border-bottom:none; }
    #historyList .idx{ opacity:.9; font-weight:800; }
    #historyList .time{ opacity:.9; }
    #historyList .val{ font-weight:900; color:var(--accent); }
    .history-summary{ margin-top:8px; font-size:13px; color:#eaf6ff; opacity:.9; }
    .history-actions{ margin-top:8px; display:flex; justify-content:flex-end; }
    .btn-mini{ padding:6px 10px; border:1px solid var(--accent); border-radius:8px; background: rgba(255,213,74,.10); color:var(--accent); font-weight:700; }
    .btn-mini.danger{ border-color:#ff8a8a; color:#ff8a8a; background:rgba(255,138,138,.08); }

    @media (max-width: 720px){
      .hud-inner{ grid-template-columns: 1fr 1fr; row-gap:8px; }
      .hud-title{ grid-column:1 / -1; order:-1; text-align:center; }
      .history-panel{ left:10px; right:10px; width:auto; }
    }

    /* ===== 主畫面：固定 5 欄 × 4 排 ===== */
    .page-mask{
      min-height:100dvh; background:rgba(0,0,0,.35);
      display:grid; place-items:center; padding: calc(var(--hud-h) + 8px) 3vmin 5vmin; transition: filter .2s ease;
    }
    .grid{
      width:min(var(--wrap-w), 100%);
      display:grid;
      /* 讓欄寬貼卡片，水平間距完全由 column-gap 控制 */
      grid-template-columns: repeat(5, auto);
      column-gap: 12px;                       /* ← 左右間距在這裡改 */
      row-gap: clamp(20px, 3.6vw, 36px);      /* ← 垂直間距沿用你的設定範圍 */
    }
    .grid.disabled .card{ pointer-events:none; }

    /* ====== 卡片：正方形 + 亮白玻璃（更透明） ====== */
    .card{
      position:relative; aspect-ratio: 1 / 1;
      --r: 16px; border-radius: var(--r);

      /* 更透明的亮白玻璃 */
      background:
        linear-gradient(180deg, rgba(255,255,255,.54), rgba(255,255,255,.36)) padding-box,
        radial-gradient(120% 160% at -10% -30%,
          rgba(255,213,74,.14),
          rgba(142,197,255,.12) 40%,
          rgba(255,255,255,0) 70%
        ) border-box;
      border: 1px solid rgba(255,255,255,.42);
      box-shadow:
        0 8px 18px rgba(0,0,0,.10),
        0 0 0 1px rgba(255,255,255,.28) inset,
        0 0 14px rgba(255,255,255,.14) inset;
      backdrop-filter: blur(12px) saturate(1.4);
      -webkit-backdrop-filter: blur(12px) saturate(1.4);
      display:flex; overflow:hidden; transform-style:preserve-3d; will-change:transform, box-shadow, filter;
      transition: transform .25s ease, box-shadow .25s ease, filter .25s ease;

      /* 卡片尺寸 & 置中 */
      width: 120px;
      justify-self: center;
    }

    /* 上緣流動條 */
    .card::before{
      content:""; position:absolute; left:0; right:0; top:0; height:4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent)); background-size:180% 100%;
      animation: barFlow 6s linear infinite;
    }
    @keyframes barFlow{ to{ background-position-x: 180%; } }

    /* 斜向光束掃過（白底稍降以免過曝） */
    .card::after{
      content:""; position:absolute; inset:-25%;
      background: linear-gradient(130deg,
        rgba(255,255,255,0),
        rgba(255,255,255,.26) 35%,
        rgba(255,255,255,0) 70%
      );
      transform: translateX(-140%) rotate(12deg);
      transition: transform 1.1s cubic-bezier(.22,.61,.36,1);
      mix-blend-mode: screen; pointer-events:none;
    }
    .card:hover::after{ transform: translateX(140%) rotate(12deg); }

    /* 星屑層 */
    .fx-sparkle{
      position:absolute; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(2px 2px at 22% 30%, rgba(255,255,255,.7), transparent 60%),
        radial-gradient(1.5px 1.5px at 68% 64%, rgba(255,213,74,.75), transparent 60%),
        radial-gradient(1.5px 1.5px at 36% 80%, rgba(142,197,255,.8), transparent 60%),
        radial-gradient(1px 1px at 82% 22%, rgba(255,255,255,.8), transparent 60%),
        radial-gradient(1px 1px at 12% 72%, rgba(255,255,255,.7), transparent 60%);
      opacity:.55; filter: drop-shadow(0 0 6px rgba(255,255,255,.35));
      animation: twinkle 3.6s ease-in-out infinite;
    }
    @keyframes twinkle{0%,100%{opacity:.38}50%{opacity:.75}}

    /* 卡面內容容器（置中） */
    .card-face{ position:relative; z-index:1; display:grid; place-items:center; width:100%; padding:10px; }

    /* 角標：左上角小膠囊「抽卡」 */
    .badge{
      position:absolute; left:10px; top:10px; padding:2px 8px; font-size:12px; font-weight:800; color:#1a2146;
      background: linear-gradient(180deg, #ffe28a, #ffd54a); border-radius:999px; box-shadow:0 4px 10px rgba(0,0,0,.35);
    }

    /* 中央符文（conic/radial gradient） */
    .glyph{
      width:64%; aspect-ratio:1/1; border-radius:50%;
      background:
        radial-gradient(closest-side, rgba(255,255,255,.18), rgba(255,255,255,0) 65%),
        conic-gradient(from 90deg, rgba(255,213,74,.25), rgba(142,197,255,.25), rgba(255,213,74,.25));
      box-shadow: 0 0 14px rgba(142,197,255,.25), inset 0 0 18px rgba(255,213,74,.18);
      position:relative; filter: saturate(1.05) brightness(1.02);
      animation: glyphPulse 4.5s ease-in-out infinite;
    }
    @keyframes glyphPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}

    /* 環軌：外圈細線 + 轉動的薄霧 */
    .glyph::before, .glyph::after{ content:""; position:absolute; inset:-10%; border-radius:50%; pointer-events:none; }
    .glyph::before{
      border:1px dashed rgba(26,33,70,.15);
      box-shadow: inset 0 0 12px rgba(142,197,255,.15);
      filter: blur(.2px);
    }
    .glyph::after{
      inset:-18%;
      background: conic-gradient(from 0deg, rgba(255,255,255,.08), rgba(255,255,255,0) 40%, rgba(255,255,255,.08), rgba(255,255,255,0) 70%);
      animation: orbit 12s linear infinite; mix-blend-mode: screen;
    }
    @keyframes orbit{ to{ transform: rotate(360deg); } }

    /* 卡面文字在亮底時改深色 */
    .title{ margin:8px 0 0; font-size:13px; font-weight:800; letter-spacing:.04em; color:#1a2146; opacity:.96; }
    .text { margin:2px 0 0; font-size:12px; color:#2b3a63; opacity:.94; }

    .card:hover{
      box-shadow:
        0 12px 28px rgba(0,0,0,.16),
        0 0 0 1px rgba(255,255,255,.30) inset,
        0 0 18px rgba(255,255,255,.16) inset;
      filter: saturate(1.06);
    }
    .card.is-press{ filter: brightness(1.04) saturate(1.08); }

    /* 退場 */
    @keyframes fadeOut{ to{ opacity:0; transform:scale(0.98);} }
    .card.fading{ animation: fadeOut .6s ease forwards; pointer-events:none; }

    /* Placeholder 卡（補版面用，不可點；亮白系，稍淡即可） */
    .card--placeholder{
      opacity:.86;
      pointer-events:none;
    }
    .card--placeholder .badge{ display:none; }

    /* 煙火 & Modal（沿用） */
    #fxFireworks{ position: fixed; inset: 0; width:100vw; height:100vh; display:none; pointer-events:none; z-index:1500; }
    .modal{ position: fixed; inset:0; display:none; z-index:2000; }
    .modal[aria-hidden="false"]{ display:grid; place-items:center; }
    .modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(2px); }
    .modal__dialog{
      position:relative; width:min(92vw, 420px); max-height:80vh; overflow:auto;
      background: rgba(10,20,60,0.9); color:#fff; border:1px solid var(--accent);
      box-shadow:0 12px 32px rgba(0,0,0,.55); border-radius:12px; padding:18px 16px 16px; outline:none;
    }
    .modal__title{ margin:0 0 8px; font-size:18px; font-weight:800; color:var(--accent); }
    .modal__body{ margin:8px 0 14px; font-size:15px; line-height:1.6; color:#eaf6ff; }
    .modal__actions{ display:flex; gap:10px; justify-content:flex-end; }
    .btn{ padding:8px 12px; border:1px solid var(--accent); background:rgba(255,213,74,.12); color:var(--accent); font-weight:800; border-radius:10px; }

    /* 置中歷史視窗 */
    #historyCenterBody ul{ list-style:none; margin:8px 0 0; padding:0; border-top:1px dashed rgba(255,255,255,.15); }
    #historyCenterBody li{ display:grid; grid-template-columns: 60px 1fr auto; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.15); font-size:14px; }
    #historyCenterBody .idx{ opacity:.9; font-weight:800; }
    #historyCenterBody .time{ opacity:.9; }
    #historyCenterBody .val{ opacity:1; font-weight:900; color:var(--accent); }

    @media (prefers-reduced-motion: reduce){
      .card, .card::after, .glyph, .fx-sparkle{ transition:none!important; animation:none!important; }
    }
  </style>
</head>
<body>

  <!-- ===== HUD ===== -->
  <header class="hud">
    <div class="hud-inner">
      <div class="hud-left">
        <div class="pill" aria-label="剩餘機會">
          <span class="dot" aria-hidden="true"></span>
          機會：<span id="chanceValue">0</span>
        </div>
      </div>

      <h1 class="hud-title">生日抽卡遊戲</h1>

      <div class="hud-right">
        <div class="score-box" aria-live="polite">
          <div class="score-title">分數</div>
          <div class="score-value" id="oriScoreValue">0</div>
        </div>

        <div class="history">
          <button class="history-toggle" id="historyToggle" aria-expanded="false" aria-controls="historyPanel">過往得分</button>
          <div class="history-panel" id="historyPanel" hidden>
            <ul id="historyList"></ul>
            <div class="history-summary" id="historySummary"></div>
            <div class="history-actions">
              <button class="btn-mini danger" id="historyClearAll">清除紀錄</button>
            </div>
          </div>
        </div>

        <button class="btn" id="btnRules" aria-haspopup="dialog">遊戲規則</button>
      </div>
    </div>
  </header>

  <!-- ===== 主畫面 ===== -->
  <div class="page-mask" id="pageMask">
    <main class="grid" id="cardContainer"></main>
  </div>

  <!-- ===== 訊息 Modal ===== -->
  <div class="modal" id="messageModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal__backdrop" id="messageBackdrop"></div>
    <div class="modal__dialog" tabindex="-1">
      <h3 class="modal__title" id="messageTitle">訊息</h3>
      <div class="modal__body" id="messageBody">—</div>
      <div class="modal__actions">
        <button class="btn" id="messageOkBtn">確定</button>
      </div>
    </div>
  </div>

  <!-- ===== 本輪總分 Modal ===== -->
  <div class="modal" id="resultModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal__backdrop" id="resultBackdrop"></div>
    <div class="modal__dialog" tabindex="-1">
      <h3 class="modal__title">本輪得分</h3>
      <div class="modal__body">目前分數：<strong id="modalScore">0</strong></div>
      <div class="modal__actions">
        <button class="btn" id="modalOkBtn">確定</button>
      </div>
    </div>
  </div>

  <!-- ===== 機會用完 → 置中歷史視窗（只能重置） ===== -->
  <div class="modal" id="historyCenterModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal__backdrop" id="historyCenterBackdrop"></div>
    <div class="modal__dialog" tabindex="-1">
      <h3 class="modal__title">機會已用完</h3>
      <div class="modal__body">
        <p style="margin-top:0">這一輪已使用完畢，下面是你的過往得分：</p>
        <div id="historyCenterBody"></div>
      </div>
      <div class="modal__actions">
        <button class="btn" id="historyCenterResetBtn" autofocus>重置遊戲</button>
      </div>
    </div>
  </div>

  <!-- 煙火 -->
  <canvas id="fxFireworks"></canvas>
  <!-- 流星尾巴 -->
  <canvas id="meteorTrail" style="position:fixed; inset:0; pointer-events:none; z-index:1700; display:block;"></canvas>

  <script>
    /* ================= 主流程 ================= */
    let gClicked = new Set();
    let gFunctionList = [];
    let gPendingResultModal = false;
    let gOutOfChanceShown = false;
    let gRoundTotal = 0; // 本輪實際可點擊卡數（不含 placeholder）

    async function onCardClick(id){
      const idx = +id.split('-')[1];
      if (isNaN(idx) || gClicked.has(idx)) return;

      const container = document.getElementById('cardContainer');
      container.classList.add('disabled');

      const el = document.getElementById(id);
      const oriEl = document.getElementById('oriScoreValue');
      const oriScore = +oriEl.textContent;

      const item = gFunctionList[idx];

      // 【FETCH】<<< 抽卡：依 key 計算結果（請回傳至少 {oriScore, title, message, chance?} ） >>>
      let response = await fetch(`/init/key/${item.key}`, { method:"POST", body: oriScore });
      response = await response.json();

      oriEl.textContent = response.oriScore;
      if ('chance' in response) updateChance(response.chance);

      gClicked.add(idx);
      el.classList.add('is-press');
      el.classList.add('fading');
      await waitAnimationEnd(el);
      container.classList.remove('disabled');

      if (item.key === 2) runFireworks();
      showMessageModal(response);

      // 只以「本輪實際可點擊卡數」判定回合結束
      gPendingResultModal = (gRoundTotal > 0 && gClicked.size === gRoundTotal);
    }

    async function init(){
      // 【FETCH】<<< 初始化：請回傳至少 {functionList, chance, oriScore} >>>
      let resp = await fetch("/init",{ method:"POST" });
      resp = await resp.json();
      console.log(resp);
      gFunctionList = resp.functionList ?? [];
      gClicked.clear();

      updateChance(resp.chance ?? 0);
      document.getElementById('oriScoreValue').textContent = resp.oriScore ?? 0;

      // 固定顯示 20 張：不足補 placeholder，超過只取前 20 張
      gRoundTotal = Math.min(20, gFunctionList.length);
      const displayList = gFunctionList.slice(0, gRoundTotal);

      const c = document.getElementById('cardContainer');
      c.innerHTML = "";

      // 先建立實際可點擊卡片（索引 0..gRoundTotal-1）
      displayList.forEach((f,i)=>{
        const a = document.createElement("article");
        a.className = "card"; a.id = `card-${i}`;
        a.innerHTML = `
          <div class="fx-sparkle" aria-hidden="true"></div>
          <div class="card-face">
            <div class="badge">抽卡</div>
            <div class="glyph" aria-hidden="true"></div>
            <h2 class="title"></h2>
            <p class="text"></p>
          </div>`;
        a.addEventListener('click', () => onCardClick(a.id));
        bindCardTilt(a);
        c.appendChild(a);
      });

      // 不足 20 張時，用 placeholder 補滿版面（不可點）
      for (let j = gRoundTotal; j < 20; j++){
        const p = document.createElement("article");
        p.className = "card card--placeholder";
        p.innerHTML = `
          <div class="fx-sparkle" aria-hidden="true"></div>
          <div class="card-face">
            <div class="glyph" aria-hidden="true"></div>
            <h2 class="title">—</h2>
            <p class="text" aria-hidden="true">—</p>
          </div>`;
        c.appendChild(p);
      }
    }

    /* -------- Modal 控制 -------- */
    function openModal(modalEl){
      modalEl.setAttribute('aria-hidden','false');
      document.body.classList.add('is-modal-open');
      document.getElementById('pageMask').inert = true;
      modalEl.querySelector('.modal__dialog')?.focus();
    }
    function hideModal(modalEl){
      if (modalEl.contains(document.activeElement)) document.activeElement.blur();
      modalEl.setAttribute('aria-hidden','true');
      document.body.classList.remove('is-modal-open');
      document.getElementById('pageMask').inert = false;
    }
    function showMessageModal(payload){
      const m = document.getElementById('messageModal');
      document.getElementById('messageTitle').textContent = payload.title ?? '訊息';
      document.getElementById('messageBody').innerHTML = `
        <p>${payload.message ?? '—'}</p>
        <p style="margin-top:10px;font-weight:bold;color:var(--accent);">剩餘金額：${payload.oriScore} 元</p>`;
      openModal(m);
    }
    function closeMessageModal(){
      hideModal(document.getElementById('messageModal'));
      stopFireworks();
      if (gPendingResultModal){ gPendingResultModal = false; showResultModal(); }
    }
    function showResultModal(){
      const finalScore = document.getElementById('oriScoreValue').textContent;
      document.getElementById('modalScore').textContent = finalScore;
      appendHistory(Number(finalScore)||0);
      openModal(document.getElementById('resultModal'));
    }
    async function closeResultModalAndReset(){
      hideModal(document.getElementById('resultModal'));
      await init();
    }

    /* ===== 機會用完：置中視窗（只能重置） ===== */
    function buildHistoryCenterHTML(){
      const data = getHistory();
      if(!data.length) return `<p style="opacity:.8;">目前沒有任何紀錄。重新開始一輪吧 ✨</p>`;

      const total = data.length;
      const list = data.map((x,i)=>`
        <li>
          <span class="idx">第${total - i}次</span>
          <span class="time">${x.at}</span>
          <strong class="val">${x.score}</strong>
        </li>
      `).join('');

      const max = data.reduce((m, x) => Math.max(m, Number(x.score)||0), 0);
      return `<ul>${list}</ul><div class="summary">總計 ${total} 場｜最高 ${max} 分</div>`;
    }
    function openHistoryCenterModal(){
      const m = document.getElementById('historyCenterModal');
      document.getElementById('historyCenterBody').innerHTML = buildHistoryCenterHTML();
      openModal(m);
    }
    function updateChance(newChance){
      const num = Number(newChance) || 0;
      const el  = document.getElementById('chanceValue');
      if (el) el.textContent = num;
      if (num <= 0 && !gOutOfChanceShown){ gOutOfChanceShown = true; openHistoryCenterModal(); }
      if (num > 0) gOutOfChanceShown = false;
    }

    // 重置：呼叫 /restore → 清空歷史 → 關視窗 → 更新 → init()
    async function handleRestore(){
      try{
        const resp = await fetch('/restore', { method: 'POST' });
        const data = await resp.json();

        const nextChance = Number(data?.chance ?? 0);
        clearHistoryAll({ silent: true });
        hideModal(document.getElementById('historyCenterModal'));
        updateChance(nextChance);
        await init();
      }catch(e){
        console.error('restore error:', e);
        alert('重置失敗，請稍後再試。');
      }
    }

    /* -------- 小工具 -------- */
    function waitAnimationEnd(el){ return new Promise(r => el.addEventListener('animationend', r, { once:true })); }

    /* -------- 煙火 -------- */
    const fw = { canvas:null, ctx:null, w:0, h:0, bursts:[], raf:0 };
    function setupFireworks(){ fw.canvas = document.getElementById('fxFireworks'); fw.ctx = fw.canvas.getContext('2d'); resizeFW(); window.addEventListener('resize', resizeFW); }
    function resizeFW(){ fw.w = fw.canvas.width = innerWidth; fw.h = fw.canvas.height = innerHeight; }
    function runFireworks(){
      if (!fw.canvas) setupFireworks();
      fw.canvas.style.display = 'block'; fw.bursts.length = 0; cancelAnimationFrame(fw.raf);
      for (let i=0;i<3;i++) spawnBurst(); fw.raf = requestAnimationFrame(stepFW);
    }
    function stopFireworks(){ cancelAnimationFrame(fw.raf); if (fw.ctx) fw.ctx.clearRect(0,0,fw.w,fw.h); if (fw.canvas) fw.canvas.style.display = 'none'; }
    function spawnBurst(){
      const cx = Math.random()*fw.w, cy = Math.random()*fw.h*0.5, color = `hsl(${Math.random()*360}, 85%, 60%)`;
      const parts=[]; for(let i=0;i<80;i++){ const ang=Math.random()*Math.PI*2, spd=Math.random()*3+1; parts.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,life:80}); }
      fw.bursts.push({ parts, color });
    }
    function stepFW(){
      const ctx = fw.ctx; ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.fillRect(0,0,fw.w,fw.h); ctx.globalCompositeOperation='lighter';
      fw.bursts.forEach(b => { b.parts.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.vy+=0.03; p.life--; ctx.fillStyle=b.color; ctx.globalAlpha=p.life/80; ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2); ctx.fill(); }); b.parts=b.parts.filter(p=>p.life>0); });
      fw.bursts = fw.bursts.filter(b=>b.parts.length>0); if (fw.bursts.length<3) spawnBurst(); fw.raf=requestAnimationFrame(stepFW);
    }

    /* ===== 過往得分（localStorage） ===== */
    const HISTORY_KEY = 'scoreHistory';
    function getHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }catch{ return []; } }
    function setHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }
    function appendHistory(score){
      const arr = getHistory();
      const now = new Date();
      arr.unshift({ score: Number(score)||0, at: now.toLocaleString('zh-TW', { hour12:false }) });
      setHistory(arr.slice(0,20));
      renderHistory();
    }
    function renderHistory(){
      const list = document.getElementById('historyList');
      const sum  = document.getElementById('historySummary');
      if(!list || !sum) return;

      const data = getHistory();
      if(!data.length){
        list.innerHTML = `<li style="grid-template-columns: 1fr;"><span style="opacity:.75;">尚無紀錄，來一把吧 ✨</span></li>`;
        sum.textContent = '';
        return;
      }

      const total = data.length;
      list.innerHTML = data.map((x,i)=>`
        <li>
          <span class="idx">第${total - i}次</span>
          <span class="time">${x.at}</span>
          <strong class="val">${x.score}</strong>
        </li>
      `).join('');

      const max = data.reduce((m, x) => Math.max(m, Number(x.score)||0), 0);
      sum.textContent = `總計 ${total} 場｜最高 ${max} 分`;
    }
    function clearHistoryAll(opts={}){ const silent=!!opts.silent; if(!silent){ if(!confirm('清除所有過往得分紀錄？此動作不可復原。')) return; } localStorage.removeItem(HISTORY_KEY); renderHistory(); }

    /* ===== History 面板 & 規則視窗 ===== */
    (function attachHistoryToggle(){
      const btn = document.getElementById('historyToggle');
      const panel = document.getElementById('historyPanel');
      if(!btn || !panel) return;
      btn.addEventListener('click', ()=>{
        const open = !panel.hasAttribute('hidden');
        if(open){ panel.setAttribute('hidden',''); btn.setAttribute('aria-expanded','false'); }
        else{ renderHistory(); panel.removeAttribute('hidden'); btn.setAttribute('aria-expanded','true'); }
      });
      document.addEventListener('click',(e)=>{ if(!panel || panel.hasAttribute('hidden')) return; if(!panel.contains(e.target) && e.target !== btn){ panel.setAttribute('hidden',''); btn.setAttribute('aria-expanded','false'); } });
    })();

    (function setupRulesModal(){
      const btn = document.getElementById('btnRules'); if(!btn) return;
      const wrap = document.createElement('div');
      wrap.style.cssText = `position:fixed; inset:0; display:none; z-index:2000;`;
      wrap.innerHTML = `
        <div class="rm-backdrop" style="position:absolute; inset:0; background:rgba(0,0,0,.55);backdrop-filter:blur(2px)"></div>
        <div role="dialog" aria-modal="true" tabindex="-1"
             style="position:relative; margin:auto; max-width:560px; width:92vw; background:rgba(10,20,60,.94); border:1px solid var(--accent); border-radius:14px; padding:18px 16px; color:#eaf6ff; box-shadow:0 18px 44px rgba(0,0,0,.6);">
          <h3 style="margin:0 0 8px; color:var(--accent); font-weight:900;">遊戲規則</h3>
          <ol style="margin:8px 0 14px; padding-left:18px; line-height:1.75;">
            <li>每回合擁有 <strong>機會 × <span id="ruleChance">—</span></strong>。</li>
            <li>點擊卡片觸發事件，分數即時加總於右上角。</li>
            <li>遇到特殊卡（如翻倍）會有特效，按「確定」繼續。</li>
            <li>一輪結束會顯示「本輪得分」，並記錄到「過往得分」。</li>
          </ol>
          <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button id="rulesClose" class="btn">了解</button>
          </div>
        </div>`;
      document.body.appendChild(wrap);
      const open = ()=>{ wrap.style.display='grid'; wrap.querySelector('#ruleChance').textContent = document.getElementById('chanceValue')?.textContent ?? '—'; document.body.style.overflow='hidden'; wrap.querySelector('[role="dialog"]').focus(); };
      const close = ()=>{ wrap.style.display='none'; document.body.style.overflow=''; };
      wrap.addEventListener('click',(e)=>{ if(e.target.classList.contains('rm-backdrop')) close(); });
      wrap.querySelector('#rulesClose').addEventListener('click', close);
      btn.addEventListener('click', open);
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && wrap.style.display!=='none') close(); });
    })();

    /* ===== 卡片 3D 傾斜（輕量） ===== */
    function bindCardTilt(card){
      const maxX = 7, maxY = 9;
      function pmove(e){
        const r = card.getBoundingClientRect();
        const x = (e.clientX - r.left) / r.width;
        const y = (e.clientY - r.top) / r.height;
        const rx = (0.5 - y) * maxX;
        const ry = (x - 0.5) * maxY;
        card.style.transform = `perspective(700px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(0)`;
      }
      function pleave(){ card.style.transform = ''; card.classList.remove('is-press'); }
      card.addEventListener('pointermove', pmove);
      card.addEventListener('pointerleave', pleave);
      card.addEventListener('pointerdown', ()=> card.classList.add('is-press'));
      card.addEventListener('pointerup',   ()=> card.classList.remove('is-press'));
    }

    /* ===== 綁定 ===== */
    document.addEventListener('DOMContentLoaded', () => {
      init();
      setupFireworks();
      document.getElementById('messageOkBtn').addEventListener('click', closeMessageModal);
      document.getElementById('messageBackdrop').addEventListener('click', closeMessageModal);
      document.getElementById('modalOkBtn').addEventListener('click', closeResultModalAndReset);
      document.getElementById('resultBackdrop').addEventListener('click', closeResultModalAndReset);

      const btnAll = document.getElementById('historyClearAll');
      if(btnAll) btnAll.addEventListener('click', ()=> clearHistoryAll());

      const btnReset  = document.getElementById('historyCenterResetBtn');
      if (btnReset) btnReset.addEventListener('click', handleRestore);

      document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;
        const msgOpen = document.getElementById('messageModal').getAttribute('aria-hidden') === 'false';
        const resOpen = document.getElementById('resultModal').getAttribute('aria-hidden') === 'false';
        if (msgOpen)      closeMessageModal();
        else if (resOpen) closeResultModalAndReset();
      });
    });

    /* ============== 流星尾巴（不覆蓋黑幕） ============== */
    (function meteorCursor(){
      if (!matchMedia('(pointer:fine)').matches) return;
      const cvs = document.getElementById('meteorTrail'); if (!cvs) return;
      const ctx = cvs.getContext('2d'); let dpr = Math.max(1, devicePixelRatio || 1);
      function resize(){ cvs.width=Math.floor(innerWidth*dpr); cvs.height=Math.floor(innerHeight*dpr); cvs.style.width=innerWidth+'px'; cvs.style.height=innerHeight+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); }
      resize(); addEventListener('resize', resize);

      const trail=[]; const MAX=24; const DECAY=0.06;
      addEventListener('mousemove', e=>{ trail.unshift({x:e.clientX||0,y:e.clientY||0,life:1}); if(trail.length>MAX) trail.pop(); }, {passive:true});
      function frame(){
        ctx.clearRect(0,0,innerWidth,innerHeight);
        ctx.globalCompositeOperation='lighter';
        for(let i=0;i<trail.length-1;i++){
          const a=trail[i], b=trail[i+1]; a.life=Math.max(0,a.life-DECAY);
          const t=i/MAX, w=6*(1-t*.9), alpha=a.life*(1-t*.95);
          const g=ctx.createLinearGradient(a.x,a.y,b.x,b.y);
          g.addColorStop(0,`rgba(255,213,74,${Math.min(.95,alpha)})`);
          g.addColorStop(1,`rgba(142,197,255,${Math.max(.3,alpha*.6)})`);
          ctx.strokeStyle=g; ctx.lineWidth=w; ctx.lineCap='round';
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        }
        for(let i=trail.length-1;i>=0;i--) if(trail[i].life<=.02) trail.splice(i,1);
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
      addEventListener('blur',()=>trail.splice(0,trail.length));
    })();
  </script>
</body>
</html>
